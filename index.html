<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Realt√† Aumentata con Marker</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        .ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            z-index: 10;
            font-size: 14px;
        }
        
        .marker-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 10;
            font-size: 14px;
            max-width: 300px;
        }
        
        .detection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 10;
            font-size: 14px;
            font-weight: bold;
        }
        
        .detected {
            background: rgba(76, 175, 80, 0.7);
        }
        
        .not-detected {
            background: rgba(244, 67, 54, 0.7);
        }
        
        .error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .error h2 {
            color: #f44336;
        }
        
        .error button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .marker-info {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .detection-status {
                top: 10px;
                right: 10px;
            }
            
            .instructions {
                bottom: 10px;
                padding: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Schermata di caricamento -->
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <h2>Avvio Realt√† Aumentata</h2>
        <p>Attivazione della telecamera in corso...</p>
    </div>
    
    <!-- Schermata di errore -->
    <div class="error" id="errorScreen">
        <h2>Errore di Accesso alla Telecamera</h2>
        <p id="errorMessage">Impossibile accedere alla telecamera. Assicurati di aver concesso i permessi necessari.</p>
        <button id="retryButton">Riprova</button>
    </div>
    
    <!-- Info marker -->
    <div class="marker-info">
        <strong>Marker: </strong>marker.patt<br>
        <strong>Modello: </strong>asset.glb<br>
        <strong>Scala: </strong>0.5<br>
        <strong>Posizione: </strong>sopra il marker
    </div>
    
    <!-- Stato rilevamento -->
    <div class="detection-status not-detected" id="statusIndicator">
        üîç Cercando marker...
    </div>
    
    <!-- Istruzioni -->
    <div class="instructions">
        Inquadra il marker con la fotocamera. Assicurati di avere una buona illuminazione.
    </div>
    
    <!-- Contenitore AR -->
    <div class="ar-container">
        <a-scene 
            id="arScene"
            vr-mode-ui="enabled: false"
            loading-screen="enabled: false"
            renderer="logarithmicDepthBuffer: true; precision: medium;"
            embedded 
            arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        >
            <!-- Marker personalizzato -->
            <a-marker 
                type="pattern" 
                url="./assets/marker.patt"
                smooth="true"
                smoothCount="10"
                smoothTolerance="0.01"
                smoothThreshold="5"
                emitevents="true"
            >
                <!-- Modello 3D -->
                <a-entity 
                    position="0 0.5 0" 
                    scale="0.5 0.5 0.5"
                    rotation="0 0 0"
                    gltf-model="./assets/asset.glb"
                    animation-mixer
                >
                </a-entity>
            </a-marker>
            
            <!-- Camera AR -->
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingScreen = document.getElementById('loadingScreen');
            const errorScreen = document.getElementById('errorScreen');
            const errorMessage = document.getElementById('errorMessage');
            const retryButton = document.getElementById('retryButton');
            const statusIndicator = document.getElementById('statusIndicator');
            const arScene = document.querySelector('a-scene');
            
            let cameraStream = null;
            
            // Funzione per attivare la telecamera
            function activateCamera() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showError("Il tuo browser non supporta l'accesso alla telecamera");
                    return;
                }
                
                // Prova a ottenere l'accesso alla telecamera posteriore su mobile
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' }, // Preferisci telecamera posteriore
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(stream) {
                        cameraStream = stream;
                        hideLoading();
                        startARScene();
                    })
                    .catch(function(err) {
                        console.error("Errore telecamera:", err);
                        
                        // Se fallisce, prova con qualsiasi telecamera
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then(function(stream) {
                                cameraStream = stream;
                                hideLoading();
                                startARScene();
                            })
                            .catch(function(err2) {
                                console.error("Errore telecamera (fallback):", err2);
                                showError("Impossibile accedere alla telecamera: " + err2.message);
                            });
                    });
            }
            
            function startARScene() {
                // La scena AR si avvia automaticamente con A-Frame
                // Aggiungi listener per il rilevamento del marker
                const marker = document.querySelector('a-marker');
                
                marker.addEventListener('markerFound', function() {
                    statusIndicator.textContent = "‚úÖ Marker rilevato!";
                    statusIndicator.className = "detection-status detected";
                });
                
                marker.addEventListener('markerLost', function() {
                    statusIndicator.textContent = "üîç Cercando marker...";
                    statusIndicator.className = "detection-status not-detected";
                });
                
                // Evento quando la scena AR √® pronta
                arScene.addEventListener('loaded', function() {
                    console.log("Scena AR caricata");
                });
            }
            
            function hideLoading() {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorScreen.style.display = 'flex';
                loadingScreen.style.display = 'none';
            }
            
            function hideError() {
                errorScreen.style.display = 'none';
                loadingScreen.style.display = 'flex';
            }
            
            // Gestione pulsante riprova
            retryButton.addEventListener('click', function() {
                hideError();
                activateCamera();
            });
            
            // Rileva se siamo su dispositivo mobile
            function isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            // Forza schermo intero su mobile al tap
            if (isMobile()) {
                document.body.addEventListener('click', function() {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    }
                }, { once: true });
            }
            
            // Avvia tutto quando la pagina √® caricata
            window.addEventListener('load', function() {
                activateCamera();
            });
            
            // Pulisci lo stream della telecamera quando la pagina viene chiusa
            window.addEventListener('beforeunload', function() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
            });
            
            // Gestione errori A-Frame
            arScene.addEventListener('error', function(e) {
                console.error("Errore A-Frame:", e.detail);
            });
        });
    </script>
</body>
</html>